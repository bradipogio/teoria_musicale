<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Esercizio di Solfeggio - Layout Responsive con Flex</title>
  <!-- Includiamo VexFlow da CDN -->
  <script src="https://unpkg.com/vexflow/releases/vexflow-debug.js"></script>
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    /* Reset di base */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f7f7f7;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    /* Contenitore principale, flessibile e centrato */
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 800px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
      margin-bottom: 20px;
      font-size: 2rem;
      text-align: center;
    }
    /* Contenitore dei controlli (select e bottone riferimento) */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 20px;
    }
    select, button {
      padding: 10px 15px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    select:focus, button:focus {
      outline: none;
      border-color: #aaa;
    }
    button:hover {
      background: #f0f0f0;
    }
    /* Area pentagramma: usiamo un contenitore flessibile che si ridimensiona */
    #notation {
      border: 1px solid #ddd;
      width: 100%;
      max-width: 600px;
      /* Impostiamo un aspect ratio per mantenere le proporzioni */
      aspect-ratio: 600 / 300;
      margin: 20px 0;
    }
    /* Bottoni delle risposte in fila, con wrapping se necessario */
    .answer-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 15px;
    }
    .answer-button {
      flex: 1 1 calc(14% - 10px);
      min-width: 50px;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .answer-button:hover {
      background: #0056b3;
    }
    /* Feedback e punteggio */
    #result, #score {
      margin-top: 15px;
      font-weight: 500;
    }
    /* Immagine di riferimento */
    #referenceContainer {
      margin-top: 20px;
      display: none;
      width: 100%;
    }
    #referenceContainer img {
      width: 100%;
      max-width: 600px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    /* Responsive: per schermi piccoli */
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      select, button {
        font-size: 0.9rem;
        padding: 8px 12px;
      }
      .answer-button {
        font-size: 0.9rem;
        padding: 8px;
        min-width: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Esercizio di Solfeggio</h1>
    <div class="controls">
      <label for="clefSelect">Seleziona chiave:</label>
      <select id="clefSelect">
        <option value="treble">Violino</option>
        <option value="bass">Basso</option>
        <option value="random">Random</option>
      </select>
      <button id="toggleReference">Mostra Riferimento</button>
    </div>
    <div id="referenceContainer">
      <!-- Sostituisci l'URL con quello della tua immagine di riferimento -->
      <img src="https://via.placeholder.com/600x300?text=Riferimento" alt="Riferimento">
    </div>
    <div id="notation"></div>
    <div class="answer-buttons">
      <button class="answer-button" data-key="C">Do</button>
      <button class="answer-button" data-key="D">Re</button>
      <button class="answer-button" data-key="E">Mi</button>
      <button class="answer-button" data-key="F">Fa</button>
      <button class="answer-button" data-key="G">Sol</button>
      <button class="answer-button" data-key="A">La</button>
      <button class="answer-button" data-key="B">Si</button>
    </div>
    <p id="result"></p>
    <p id="score">Punteggio: 0</p>
  </div>

  <script>
    // Array delle note (nome italiano e tasto corrispondente)
    const notes = [
      { italian: "Do", key: "C" },
      { italian: "Re", key: "D" },
      { italian: "Mi", key: "E" },
      { italian: "Fa", key: "F" },
      { italian: "Sol", key: "G" },
      { italian: "La", key: "A" },
      { italian: "Si", key: "B" }
    ];

    // Mappatura per VexFlow (in questo esempio usiamo la stessa per violino e basso)
    const noteMapping = {
      treble: {
        C: "c/4",
        D: "d/4",
        E: "e/4",
        F: "f/4",
        G: "g/4",
        A: "a/4",
        B: "b/4"
      },
      bass: {
        C: "c/4",
        D: "d/4",
        E: "e/4",
        F: "f/4",
        G: "g/4",
        A: "a/4",
        B: "b/4"
      }
    };

    let currentNote = null;
    let currentClef = "treble";
    let score = 0;

    const VF = Vex.Flow;
    const notationDiv = document.getElementById("notation");

    function clearNotation() {
      notationDiv.innerHTML = "";
    }

    // Disegna la nota usando VexFlow. Il renderer viene ridimensionato in base alle dimensioni massime del container.
    function drawNote(noteKey, clef) {
      clearNotation();
      // Impostiamo una larghezza e altezza che possano scalare bene (corrispondono all'aspect ratio definito nel CSS)
      const renderer = new VF.Renderer(notationDiv, VF.Renderer.Backends.SVG);
      renderer.resize(600, 300);
      const context = renderer.getContext();
      const stave = new VF.Stave(10, 100, 580);
      stave.addClef(clef).setContext(context).draw();
      const keyString = noteMapping[clef][noteKey];
      const staveNote = new VF.StaveNote({ keys: [keyString], duration: "q" });
      const voice = new VF.Voice({ num_beats: 1, beat_value: 4 });
      voice.addTickable(staveNote);
      new VF.Formatter().joinVoices([voice]).format([voice], 500);
      voice.draw(context, stave);
    }

    function generateRandomNote() {
      const randomIndex = Math.floor(Math.random() * notes.length);
      currentNote = notes[randomIndex];
      const clefChoice = document.getElementById("clefSelect").value;
      currentClef = clefChoice === "random"
        ? (Math.random() < 0.5 ? "treble" : "bass")
        : clefChoice;
      drawNote(currentNote.key, currentClef);
      document.getElementById("result").textContent = "";
    }

    function checkAnswer(selectedKey) {
      if (selectedKey === currentNote.key) {
        document.getElementById("result").textContent = "Corretto!";
        score++;
        document.getElementById("score").textContent = "Punteggio: " + score;
        setTimeout(generateRandomNote, 1000);
      } else {
        document.getElementById("result").textContent = "Sbagliato, riprova!";
      }
    }

    // Event listener per i bottoni delle risposte
    const answerButtons = document.querySelectorAll(".answer-button");
    answerButtons.forEach(button => {
      button.addEventListener("click", function() {
        const selectedKey = button.getAttribute("data-key");
        checkAnswer(selectedKey);
      });
    });

    // Gestione del bottone per mostrare/chiudere l'immagine di riferimento
    const toggleReferenceButton = document.getElementById("toggleReference");
    const referenceContainer = document.getElementById("referenceContainer");
    toggleReferenceButton.addEventListener("click", function() {
      if (referenceContainer.style.display === "none" || referenceContainer.style.display === "") {
        referenceContainer.style.display = "block";
        toggleReferenceButton.textContent = "Chiudi Riferimento";
      } else {
        referenceContainer.style.display = "none";
        toggleReferenceButton.textContent = "Mostra Riferimento";
      }
    });

    // Genera la prima nota al caricamento della pagina
    generateRandomNote();
  </script>
</body>
</html>
