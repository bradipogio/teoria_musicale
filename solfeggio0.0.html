<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Esercizio di Solfeggio - Nuove Modalità (Range personalizzati), Statistiche e Reset</title>
  <!-- Includiamo VexFlow da CDN (versione 3.x per compatibilità) -->
  <script src="https://unpkg.com/vexflow/releases/vexflow-debug.js"></script>
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    /* Reset di base */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f7f7f7;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: 500;
    }
    /* Controlli: dropdown per la chiave, radio group per la difficoltà e bottone per il riferimento */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    label {
      font-size: 1rem;
    }
    select, button {
      padding: 10px 15px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    select:focus, button:focus {
      outline: none;
      border-color: #aaa;
    }
    button:hover {
      background: #f0f0f0;
    }
    /* Radio group per la difficoltà */
    .radio-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .radio-group input[type="radio"] {
      display: none;
    }
    .radio-group label {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      background: #fafafa;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .radio-group input[type="radio"]:checked + label {
      background: #007BFF;
      color: #fff;
      border-color: #007BFF;
    }
    /* Contenitore dell'immagine di riferimento */
    #referenceContainer {
      margin-bottom: 20px;
      display: none;
    }
    #referenceContainer img {
      width: 100%;
      max-width: 600px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    /* Wrapper fisso per il pentagramma */
    #notationWrapper {
      width: 220px;
      height: 200px;
      margin: 20px auto;
      border: 1px solid #ddd;
      overflow: hidden;
    }
    /* Area in cui VexFlow disegna il pentagramma */
    #notation {
      width: 100%;
      height: 100%;
    }
    /* Bottoni per le risposte (note) */
    .answer-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    .answer-button {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
      flex: 1 1 auto;
      margin: 5px;
    }
    .answer-button:hover {
      background: #0056b3;
    }
    /* Feedback */
    #result {
      font-weight: 500;
      margin-top: 15px;
      font-size: 1.2rem;
    }
    /* Sezione statistiche */
    .stats {
      margin-top: 20px;
    }
    .stats p {
      font-size: 1rem;
      margin: 5px 0;
    }
    /* Responsive per schermi piccoli */
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      .answer-button, select, button, .radio-group label {
        font-size: 0.9rem;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Esercizio di Solfeggio</h1>
    
    <!-- Controlli: dropdown per la chiave, radio group per la difficoltà e bottone per il riferimento -->
    <div class="controls">
      <label for="clefSelect">Seleziona chiave:</label>
      <select id="clefSelect">
        <option value="treble">Violino</option>
        <option value="bass">Basso</option>
        <option value="random">Random</option>
      </select>
      
      <!-- Radio group per la difficoltà -->
      <div class="radio-group">
        <input type="radio" id="easy" name="difficulty" value="easy" checked>
        <label for="easy">Facile</label>
        <input type="radio" id="hard" name="difficulty" value="hard">
        <label for="hard">Difficile</label>
      </div>
      
      <button id="toggleReference">Mostra Riferimento</button>
    </div>
    
    <!-- Immagine di riferimento -->
    <div id="referenceContainer">
      <img src="https://github.com/bradipogio/teoria_musicale/blob/main/Schermata-2021-01-19-alle-10.03.13-1030x299.png?raw=true" alt="Riferimento">
    </div>
    
    <!-- Wrapper fisso per il pentagramma -->
    <div id="notationWrapper">
      <div id="notation"></div>
    </div>
    
    <!-- Bottoni per le risposte -->
    <div class="answer-buttons">
      <button class="answer-button" data-key="C">Do</button>
      <button class="answer-button" data-key="D">Re</button>
      <button class="answer-button" data-key="E">Mi</button>
      <button class="answer-button" data-key="F">Fa</button>
      <button class="answer-button" data-key="G">Sol</button>
      <button class="answer-button" data-key="A">La</button>
      <button class="answer-button" data-key="B">Si</button>
    </div>

    <!-- Sezione statistiche e reset -->
    <div class="stats">
      <p id="scoreInfo">Corrette: 0, Sbagliate: 0, Percentuale: 0%</p>
      <button id="resetButton">Reset</button>
    </div>
        
    <!-- Feedback -->
    <p id="result"></p>
    
  </div>
  
  <script>
    // Variabili per le statistiche
    let correctCount = 0;
    let wrongCount = 0;
    
    // Variabile per la difficoltà: "easy" o "hard"
    let difficulty = "easy";
    
    // Array delle note (le lettere) sempre in maiuscolo
    const notes = ["C", "D", "E", "F", "G", "A", "B"];
    let currentNote = "";
    let currentClef = "treble";
    let currentOctave = 4;  // verrà deciso in base alla modalità e alla chiave
    
    /*  
      Mappature per modalità FACILE:
      - Violino facile: devono essere nel range [C4, F5].  
        Per semplicità scegliamo una mappatura fissa:
          C, D, E, F, G, A, B  →  sempre in ottava 4.
          (C4 = 261 Hz, B4 = 493 Hz; questo è un sottoinsieme di [C4,F5])
      - Basso facile: devono essere nel range [E2, A3].  
          E → E2, F → F2, G → G2, B → B2, C → C3, D → D3, A → A3.
    */
    const easyMappingTreble = {
      "C": 4,
      "D": 4,
      "E": 4,
      "F": 4,
      "G": 4,
      "A": 4,
      "B": 4
    };
    const easyMappingBass = {
      "C": 3,
      "D": 3,
      "E": 2,
      "F": 2,
      "G": 2,
      "A": 3,
      "B": 2
    };
    
    /*  
      Mappature per modalità DIFFICILE:
      - Violino difficile: range [F3, C6].
          Possibili valori (in base alla lettera):
            C: [4, 5, 6]
            D: [4, 5]        (D3 sarebbe troppo basso, D6 troppo alto)
            E: [4, 5]
            F: [3, 4, 5]     (F3 è il minimo)
            G: [3, 4, 5]
            A: [3, 4, 5]
            B: [3, 4, 5]
      - Basso difficile: range [A1, E6].
          Possibili valori (in base alla lettera):
            A: [1, 2, 3, 4, 5]
            B: [1, 2, 3, 4, 5]
            C: [2, 3, 4, 5, 6]  (C1 sarebbe troppo basso)
            D: [2, 3, 4, 5, 6]
            E: [2, 3, 4, 5, 6]
            F: [2, 3, 4, 5]     (F6 sarebbe troppo alto)
            G: [2, 3, 4, 5]
    */
    const hardMappingTreble = {
      "C": [4, 5, 6],
      "D": [4, 5],
      "E": [4, 5],
      "F": [3, 4, 5],
      "G": [3, 4, 5],
      "A": [3, 4, 5],
      "B": [3, 4, 5]
    };
    const hardMappingBass = {
      "A": [1, 2, 3, 4, 5],
      "B": [1, 2, 3, 4, 5],
      "C": [2, 3, 4, 5, 6],
      "D": [2, 3, 4, 5, 6],
      "E": [2, 3, 4, 5, 6],
      "F": [2, 3, 4, 5],
      "G": [2, 3, 4, 5]
    };
    
    const VF = Vex.Flow;
    const notationDiv = document.getElementById("notation");
    
    // Funzione per disegnare la nota sul pentagramma
    function drawNote(note, clef, octave) {
      notationDiv.innerHTML = "";
      const renderer = new VF.Renderer(notationDiv, VF.Renderer.Backends.SVG);
      renderer.resize(220, 200);
      const context = renderer.getContext();
      // Posizioniamo il pentagramma a y = 50 per dare più spazio verticale
      const stave = new VF.Stave(10, 50, 200);
      stave.addClef(clef).setContext(context).draw();
      const key = note.toLowerCase() + "/" + octave;
      const staveNote = new VF.StaveNote({ keys: [key], duration: "q" });
      const voice = new VF.Voice({ num_beats: 1, beat_value: 4 });
      voice.addTickable(staveNote);
      new VF.Formatter().joinVoices([voice]).format([voice], 100);
      voice.draw(context, stave);
    }
    
    // Genera una nota casuale e determina l'ottava in base alla modalità e alla chiave
    function generateRandomNote() {
      const randomIndex = Math.floor(Math.random() * notes.length);
      currentNote = notes[randomIndex];
      
      // Seleziona la chiave dal dropdown
      const clefChoice = document.getElementById("clefSelect").value;
      if (clefChoice === "random") {
        currentClef = Math.random() < 0.5 ? "treble" : "bass";
      } else {
        currentClef = clefChoice;
      }
      
      // Legge la scelta della difficoltà dal radio group
      const radios = document.getElementsByName("difficulty");
      radios.forEach(radio => {
        if (radio.checked) {
          difficulty = radio.value;
        }
      });
      
      if (difficulty === "easy") {
        if (currentClef === "treble") {
          currentOctave = easyMappingTreble[currentNote];
        } else { // bass
          currentOctave = easyMappingBass[currentNote];
        }
      } else { // modalità "hard"
        if (currentClef === "treble") {
          const allowed = hardMappingTreble[currentNote];
          currentOctave = allowed[Math.floor(Math.random() * allowed.length)];
        } else { // bass
          const allowed = hardMappingBass[currentNote];
          currentOctave = allowed[Math.floor(Math.random() * allowed.length)];
        }
      }
      
      drawNote(currentNote, currentClef, currentOctave);
      document.getElementById("result").textContent = "";
    }
    
    // Aggiorna le statistiche
    function updateStats() {
      const total = correctCount + wrongCount;
      const percentage = total > 0 ? Math.round((correctCount / total) * 100) : 0;
      document.getElementById("scoreInfo").textContent =
        `Corrette: ${correctCount}, Sbagliate: ${wrongCount}, Percentuale: ${percentage}%`;
    }
    
    // Controlla se la risposta (basata sulla lettera, ignorando l'ottava) è corretta
    function checkAnswer(selectedKey) {
      if (selectedKey === currentNote) {
        document.getElementById("result").textContent = "Corretto!";
        correctCount++;
        updateStats();
        setTimeout(generateRandomNote, 100);
      } else {
        document.getElementById("result").textContent = "Sbagliato, riprova!";
        wrongCount++;
        updateStats();
      }
    }
    
    // Event listener per i bottoni delle risposte
    const answerButtons = document.querySelectorAll(".answer-button");
    answerButtons.forEach(button => {
      button.addEventListener("click", function() {
        const selectedKey = button.getAttribute("data-key");
        checkAnswer(selectedKey);
      });
    });
    
    // Gestione del bottone per mostrare/chiudere l'immagine di riferimento
    const toggleReferenceButton = document.getElementById("toggleReference");
    const referenceContainer = document.getElementById("referenceContainer");
    toggleReferenceButton.addEventListener("click", function() {
      if (referenceContainer.style.display === "none" || referenceContainer.style.display === "") {
        referenceContainer.style.display = "block";
        toggleReferenceButton.textContent = "Chiudi Riferimento";
      } else {
        referenceContainer.style.display = "none";
        toggleReferenceButton.textContent = "Mostra Riferimento";
      }
    });
    
    // Gestione del bottone di reset
    document.getElementById("resetButton").addEventListener("click", function() {
      correctCount = 0;
      wrongCount = 0;
      updateStats();
      document.getElementById("result").textContent = "";
      generateRandomNote();
    });
    
    // Assicuriamoci che l'immagine di riferimento sia nascosta all'avvio
    referenceContainer.style.display = "none";
    
    // Genera la prima nota al caricamento della pagina
    generateRandomNote();
  </script>
</body>
</html>
