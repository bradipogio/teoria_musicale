<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allenamento Accordi</title>
  
  <!-- Include Tone.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  
  <!-- Include Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
  
  <style>
    /* Stili generali */
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 10px;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .home-button {
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s;
    }
    .home-button:hover {
      background: #0056b3;
      transform: scale(1.05);
    }
    h1 {
      margin: 0;
      font-size: 22px;
    }
    
    /* Input moderno con Floating Label */
    .input-container {
      position: relative;
      margin: 20px auto;
      max-width: 300px;
      text-align: left;
      display: flex;
      flex-direction: column;
    }
    .input-container input {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
      background: #fff;
    }
    .input-container input:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    .input-container label {
      position: absolute;
      top: 12px;
      left: 12px;
      color: #aaa;
      font-size: 16px;
      pointer-events: none;
      transition: all 0.3s ease;
      background-color: white;
      padding: 0 4px;
    }
    .input-container input:focus + label,
    .input-container input:not(:placeholder-shown) + label {
      top: -10px;
      left: 10px;
      font-size: 12px;
      color: #007bff;
    }
    
    /* Pannello di configurazione */
    #config-panel {
      border: 1px solid #ccc;
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto 10px auto;
      background: #fff;
      position: relative;
    }
    #config-panel h2 {
      margin-top: 0;
      font-size: 20px;
    }
    #config-panel label,
    #config-panel p {
      font-size: 14px;
      margin: 5px;
    }
    
    /* Pannello per le shortcut */
    #shortcuts-panel {
      border: 1px solid #ccc;
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 600px;
      margin: 10px auto;
      background: #fff;
      display: none;
    }
    #shortcuts-panel h3 {
      margin-top: 0;
      font-size: 18px;
    }
    #shortcuts-panel label {
      font-size: 14px;
      margin: 5px;
      display: inline-block;
    }
    #shortcuts-panel input {
      width: 30px;
      text-align: center;
    }
    
    /* Pulsanti */
    #view-leaderboard {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #28a745;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s;
    }
    #view-leaderboard:hover {
      background: #218838;
      transform: scale(1.05);
    }
    .toggle-btn {
      padding: 8px 12px;
      font-size: 14px;
      border: 2px solid #007bff;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      margin: 3px;
      transition: background 0.3s, color 0.3s, transform 0.2s;
    }
    .toggle-btn:hover,
    .toggle-btn.active {
      transform: scale(1.1);
    }
    .toggle-btn.active {
      background: #ffd700;
      color: #000;
    }
    .game-button {
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #ffd700;
      color: #000;
      cursor: pointer;
      margin: 3px;
      min-width: 130px;
      transition: background 0.3s ease, transform 0.2s;
    }
    .game-button:hover {
      transform: scale(1.05);
    }
    .game-button2 {
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #ffd700;
      color: #000;
      cursor: pointer;
      margin: 3px;
      min-width: 13px;
      transition: background 0.3s ease, transform 0.2s;
    }
    .game-button2:hover {
      transform: scale(1.05);
    }
    
    /* Pannello Admin */
    #admin-panel {
      border: 1px solid #aaa;
      padding: 8px;
      border-radius: 6px;
      max-width: 600px;
      margin: 5px auto;
      background: #f9f9f9;
      display: none;
    }
    #admin-panel h3 {
      margin-top: 0;
      font-size: 16px;
    }
    #admin-panel table {
      width: 100%;
      border-collapse: collapse;
    }
    #admin-panel th,
    #admin-panel td {
      border: 1px solid #777;
      padding: 4px;
      text-align: center;
      font-size: 13px;
    }
    #admin-panel button {
      margin: 2px;
      padding: 4px 8px;
      font-size: 12px;
    }
    
    /* Admin Login */
    #admin-login {
      border: 1px solid #777;
      padding: 8px;
      margin: 10px auto;
      max-width: 300px;
      border-radius: 4px;
      background: #eee;
      display: none;
    }
    #admin-login input[type="password"] {
      padding: 4px;
      font-size: 14px;
      width: 80%;
      margin-bottom: 5px;
    }
    
    /* Admin Metriche */
    #admin-metrics {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 4px;
      text-align: left;
    }
    #admin-metrics p {
      font-size: 16px;
      margin: 5px 0;
    }
    
    /* Bottone Bonus */
    #bonus-indicator {
      display: inline-block;
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #ccc;  /* Grigio di default */
      color: #000;
      margin: 3px;
      min-width: 130px;
      transition: background 0.3s;
    }
    /* Stato bonus attivo (3-9 corrette): bottone rosso con pulsazione */
    #bonus-indicator.bonus-active {
      background-color: red;
      color: #fff;
      animation: bonusPulse 0.5s infinite;
    }
    @keyframes bonusPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    /* Stato rainbow (>=10 corrette): solo il colore cambia in modo dinamico senza ruotare il bottone */
    #bonus-indicator.rainbow {
      animation: rainbowCycle 3s linear infinite, rainbowPulse 0.5s infinite;
      color: #fff;
             

    }
    @keyframes rainbowPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    @keyframes rainbowCycle {
      0% { background-color: red; }
      16.67% { background-color: yellow; }
      33.33% { background-color: blue; }
      33.34% { background-color: blue; }
      50% { background-color: red; }
      66.67% { background-color: yellow; }
      66.68% { background-color: yellow; }
      83.33% { background-color: blue; }
      100% { background-color: red; }
    }
    
    /* Timer */
    @keyframes blinkRed {
      0% { background-color: #007bff; }
      50% { background-color: red; }
      100% { background-color: #007bff; }
    }
    .time-warning {
      animation: blinkRed 1s infinite;
    }
    
    /* Pannello di gioco */
    #game-panel {
      display: none;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto 10px auto;
      background: #fff;
    }
    #game-controls {
      margin-bottom: 10px;
    }
    #scoreboard {
      font-size: 16px;
      font-weight: bold;
      margin: 5px 0;
    }
    #timer-container {
      width: 100%;
      max-width: 600px;
      height: 20px;
      background: #ccc;
      border-radius: 10px;
      margin: 5px auto;
      overflow: hidden;
    }
    #timer-bar {
      height: 100%;
      width: 100%;
      background: #007bff;
    }
    
    /* Bottoni per le risposte */
    .chord-button {
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #ffd700;
      color: #000;
      cursor: pointer;
      margin: 3px;
      min-width: 130px;
      transition: background 0.3s ease, transform 0.2s;
    }
    .flash-correct {
      background: #28a745 !important;
      transform: scale(1.1) !important;
    }
    .flash-wrong {
      background: #dc3545 !important;
      transform: scale(1.1) !important;
    }
    
    /* Area feedback */
    #chord-info {
      margin-top: 5px;
      font-size: 14px;
      font-weight: bold;
      color: #000;
      min-height: 30px;
    }
    
    /* Tastiera: centrata con FlexBox e nascosta di default */
    #keyboard {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      width: 90%;
      max-width: 600px;
      margin: 10px auto;
      user-select: none;
    }
    .white-key, .black-key {
      position: absolute;
      box-sizing: border-box;
      cursor: pointer;
    }
    .white-key {
      background: #fff;
      border: 1px solid #000;
    }
    .white-key.active {
      background: #ffd700;
    }
    .black-key {
      background: #000;
      border: 1px solid #000;
      z-index: 2;
      border-radius: 0 0 5px 5px;
    }
    .black-key.active {
      background: #ffa500;
    }
    .key-label {
      position: absolute;
      bottom: 5px;
      width: 100%;
      text-align: center;
      font-size: 12px;
      color: #000;
      pointer-events: none;
    }
    
    /* Leaderboard */
    #leaderboard-panel {
      border: 1px solid #ccc;
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 600px;
      margin: 10px auto;
      background: linear-gradient(135deg, #f1f1f1, #e9e9e9);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: none;
    }
    #leaderboard-panel h2 {
      margin-top: 0;
      font-size: 18px;
    }
    #leaderboard-panel table {
      width: 100%;
      border-collapse: collapse;
    }
    #leaderboard-panel th,
    #leaderboard-panel td {
      padding: 6px;
      border: 1px solid #888;
      font-size: 14px;
    }
    #leaderboard-panel tr:nth-child(even) {
      background: #e9e9e9;
    }
    #leaderboard-panel tr.highlight {
      background: rgb(255, 217, 0);
    }
    #leaderboard-panel {
  position: relative;
}
#close-leaderboard {
  position: absolute;
  top: 10px;
  right: 10px;
}
#leaderboard-content {
  max-height: 500px; /* Imposta l'altezza massima desiderata */
  overflow-y: auto;
}

    
    /* Bottone admin (*) */
    #admin-btn {
      font-size: 12px;
      padding: 4px 6px;
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
  
  <!-- Firebase Initialization -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB9TrMyxcJYd4kQ3YJtHy0lz_tgCO-_CX8",
      authDomain: "allenamentoaccordi.firebaseapp.com",
      projectId: "allenamentoaccordi",
      storageBucket: "allenamentoaccordi.firebasestorage.app",
      messagingSenderId: "53013553677",
      appId: "1:53013553677:web:7985a84a245aef5894eb44"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  
</head>
<body>
  <header>
    <a href="https://bradipogio.github.io/teoria_musicale/indice.html" class="home-button">üè† Home</a>
    <h1>Allenamento Accordi</h1>
  </header>
  
  <!-- Pannello di configurazione -->
  <div id="config-panel">
    <h2>Impostazioni Di Gioco</h2>
    <!-- Input moderno con floating label per il nome utente -->
    <div class="input-container">
      <input type="text" id="player-name" placeholder=" " required>
      <label for="player-name">Inserisci il tuo nome</label>
    </div>
    <div id="chord-selection">
      <p>Seleziona i tipi di accordi su cui allenarti:</p>
      <button type="button" class="toggle-btn active" data-chord="">Maggiore</button>
      <button type="button" class="toggle-btn active" data-chord="m">Minore</button>
      <button type="button" class="toggle-btn" data-chord="7">7</button>
      <button type="button" class="toggle-btn" data-chord="maj7">maj7</button>
      <button type="button" class="toggle-btn" data-chord="m(maj7)">min‚Äëmaj7</button>
      <button type="button" class="toggle-btn" data-chord="aug">Aumentato</button>
      <button type="button" class="toggle-btn" data-chord="dim">Diminuito</button>
      <button type="button" class="toggle-btn" data-chord="sus2">sus2</button>
      <button type="button" class="toggle-btn" data-chord="sus4">sus4</button>
    </div>
    <div id="keyboard-option">
      <!-- La tastiera √® disabilitata di default -->
      <label>
        <input type="checkbox" id="toggle-keyboard"> Mostra tastiera
      </label>
    </div>
    <!-- Pulsanti per le modalit√† di gioco -->
    <button id="start-game" class="game-button">Inizia Gioco</button>
    <button id="view-leaderboard" class="game-button">Visualizza Classifica</button>
    <button id="start-trial" class="game-button">Prova</button>
    <button id="toggle-shortcuts" class="game-button">Configura Shortcuts</button>
    <!-- Pannello per configurare le shortcut -->
    <div id="shortcuts-panel">
      <h3>Configura Shortcut per rispondere agli accordi</h3>
      <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
        <label>Maggiore: <input type="text" id="shortcut-major" maxlength="1" value="Q"></label>
        <label>Minore: <input type="text" id="shortcut-m" maxlength="1" value="W"></label>
        <label>Settima: <input type="text" id="shortcut-7" maxlength="1" value="E"></label>
        <label>maj7: <input type="text" id="shortcut-maj7" maxlength="1" value="R"></label>
        <label>min‚Äëmaj7: <input type="text" id="shortcut-mmaj7" maxlength="1" value="T"></label>
        <label>Aumentato: <input type="text" id="shortcut-aug" maxlength="1" value="Y"></label>
        <label>Diminuito: <input type="text" id="shortcut-dim" maxlength="1" value="U"></label>
        <label>sus2: <input type="text" id="shortcut-sus2" maxlength="1" value="I"></label>
        <label>sus4: <input type="text" id="shortcut-sus4" maxlength="1" value="O"></label>
      </div>
    </div>
    
    <!-- Bottone Admin -->
    <button id="admin-btn" class="game-button2">*</button>
    
    <!-- Admin Login -->
    <div id="admin-login">
      <p>Inserisci la password admin:</p>
      <input type="password" id="admin-password" placeholder="Password">
      <button id="admin-login-btn" class="game-button">Login</button>
    </div>
    
    <!-- Pannello Admin (visibile solo in admin) -->
    <div id="admin-panel">
      <div id="admin-metrics">
        <p><strong>Visite Totali:</strong> <span id="totalVisits">0</span></p>
        <p><strong>Visitatori Unici:</strong> <span id="uniqueVisitors">0</span></p>
        <p><strong>Partite Giocate:</strong> <span id="gamesPlayed">0</span></p>
        <button id="refreshMetrics" class="game-button">Aggiorna Dati</button>
        <button id="clear-leaderboard" class="game-button">Cancella Tutti i Punteggi</button>
        <button id="close-admin" class="game-button">Chiudi Admin</button>
      </div>
      <h3>Modifica Classifica</h3>
      <div id="admin-leaderboard"></div>

    </div>
  </div>
  
  <!-- Pannello di gioco -->
  <div id="game-panel">
    <div id="game-controls">
      <button id="end-game" class="game-button">Termina Gioco</button>
      <button id="replay-chord" class="game-button">Riascolta Accordo</button>
      <div id="scoreboard">Punteggio: 0</div>
      <div id="timer-container">
        <div id="timer-bar"></div>
      </div>
      <button id="bonus-indicator" class="game-button">Bonus</button>
    </div>
    <div id="chord-buttons"></div>
    <div id="chord-info"></div>
    <!-- La tastiera √® centrata grazie a FlexBox e, di default, non viene mostrata -->
    <div id="keyboard"></div>
  </div>
  
  <!-- Pannello classifica -->
  <div id="leaderboard-panel">
    <h2>Classifica</h2>
    <div id="leaderboard-content"></div>
    <button id="close-leaderboard" class="game-button">Chiudi Classifica</button>
  </div>
  
  <!-- Codice JavaScript -->
  <script>
    (function() {
      // Variabili globali per il gioco
      let gameActive = false;
      let trialMode = false; // Modalit√† "Prova"
      let score = 0;
      let currentChordType = "";
      let selectedRoot = "";
      let allowedChordTypes = [];
      const allowedRootNotes = ["C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4"];
      const soundOn = true;
      const defaultUseSharps = true;
      const FIXED_DURATION = 60000; // 60 secondi
      let globalTimerInterval;
      let gameEndTime;
      let consecutiveCorrect = 0;
      let lastChordNotes = []; // Per il replay (arpeggio)
      const bonusIndicator = document.getElementById('bonus-indicator');
      let updateLeaderboardFlag = true;
      let displayedScore = 0;  // Per l'animazione del punteggio
      
      // Shortcut personalizzabili (default)
      let customShortcuts = {
        "": "Q",         // Maggiore
        "m": "W",        // Minore
        "7": "E",
        "maj7": "R",
        "m(maj7)": "T",
        "aug": "Y",
        "dim": "U",
        "sus2": "I",
        "sus4": "O"
      };
      
      // ---------------------------
      // FUNZIONI METRICS (Firestore)
      // ---------------------------
      function updateVisitCounters() {
        db.collection("metrics").doc("counters").update({
          totalVisits: firebase.firestore.FieldValue.increment(1)
        });
        if (!localStorage.getItem("visited")) {
          localStorage.setItem("visited", "true");
          db.collection("metrics").doc("counters").update({
            uniqueVisitors: firebase.firestore.FieldValue.increment(1)
          });
        }
      }
      
      function updateGamePlayedCounter() {
        db.collection("metrics").doc("counters").update({
          gamesPlayed: firebase.firestore.FieldValue.increment(1)
        });
      }
      
      function loadMetrics() {
        db.collection("metrics").doc("counters").get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("totalVisits").textContent = data.totalVisits;
              document.getElementById("uniqueVisitors").textContent = data.uniqueVisitors;
              document.getElementById("gamesPlayed").textContent = data.gamesPlayed;
            } else {
              console.log("Documento 'counters' non trovato.");
            }
          })
          .catch(error => {
            console.error("Errore nel caricamento dei dati metrici:", error);
          });
      }
      
      window.addEventListener("load", updateVisitCounters);
      document.getElementById("refreshMetrics").addEventListener("click", loadMetrics);
      
      // ---------------------------
      // FUNZIONI DEL GIOCO
      // ---------------------------
      async function updateLeaderboard(name, score) {
        try {
          await db.collection("leaderboard").add({
            name: name,
            score: score,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (e) {
          console.error("Errore aggiornando la leaderboard:", e);
        }
      }
      
      async function getLeaderboardData() {
        let leaderboard = [];
        try {
          const querySnapshot = await db.collection("leaderboard").orderBy("score", "desc").get();
          querySnapshot.forEach((doc) => {
            let data = doc.data();
            data.id = doc.id;
            leaderboard.push(data);
          });
        } catch (e) {
          console.error("Errore leggendo la leaderboard:", e);
        }
        return leaderboard;
      }
      
      async function renderLeaderboard() {
        let leaderboard = await getLeaderboardData();
        let content = "<table>";
        content += "<tr><th>Rank</th><th>Nome</th><th>Punteggio</th><th>Azioni</th></tr>";
        leaderboard.forEach((entry, index) => {
          content += `<tr data-id="${entry.id}"><td>${index+1}</td><td>${entry.name}</td><td>${entry.score}</td>
                      <td><button class="admin-delete" data-id="${entry.id}">Elimina</button></td></tr>`;
        });
        content += "</table>";
        return content;
      }
      
      async function showLeaderboard(playerName, playerScore) {
        let leaderboard = await getLeaderboardData();
        let content = "<table>";
        content += "<tr><th>Rank</th><th>Nome</th><th>Punteggio</th></tr>";
        leaderboard.forEach((entry, index) => {
          let highlight = (entry.name === playerName && entry.score === playerScore) ? "highlight" : "";
          content += `<tr class="${highlight}"><td>${index+1}</td><td>${entry.name}</td><td>${entry.score}</td></tr>`;
        });
        content += "</table>";
        document.getElementById("leaderboard-content").innerHTML = content;
  document.getElementById("leaderboard-panel").style.display = "block";

// Attendi che il DOM abbia aggiornato il contenuto, poi avvia l'animazione
setTimeout(() => {
  scrollToHighlighted();
}, 100);
      }
      
      document.addEventListener("click", async function(e) {
        if (e.target && e.target.classList.contains("admin-delete")) {
          let docId = e.target.getAttribute("data-id");
          try {
            await db.collection("leaderboard").doc(docId).delete();
            document.getElementById("admin-leaderboard").innerHTML = await renderLeaderboard();
          } catch (err) {
            console.error("Errore eliminando l'entry:", err);
          }
        }
      });
      
      // ADMIN: Gestione login
      const adminBtn = document.getElementById("admin-btn");
      const adminLoginDiv = document.getElementById("admin-login");
      const adminPanelDiv = document.getElementById("admin-panel");
      const adminLoginBtn = document.getElementById("admin-login-btn");
      const adminPasswordInput = document.getElementById("admin-password");
      
      adminBtn.addEventListener("click", function() {
        adminLoginDiv.style.display = "block";
        adminPasswordInput.focus();
      });
      
      adminLoginBtn.addEventListener("click", function() {
        const pass = adminPasswordInput.value;
        if (pass === "admin123") {
          adminLoginDiv.style.display = "none";
          adminPanelDiv.style.display = "block";
          loadMetrics();
          renderLeaderboard().then(content => {
            document.getElementById("admin-leaderboard").innerHTML = content;
          });
        } else {
          alert("Password errata!");
        }
        adminPasswordInput.value = "";
      });
      
      adminPasswordInput.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          adminLoginBtn.click();
        }
      });
      
      document.getElementById("clear-leaderboard").addEventListener("click", async function() {
        if (confirm("Sei sicuro di voler cancellare tutta la classifica?")) {
          let leaderboard = await getLeaderboardData();
          leaderboard.forEach(async (entry) => {
            await db.collection("leaderboard").doc(entry.id).delete();
          });
          document.getElementById("admin-leaderboard").innerHTML = await renderLeaderboard();
        }
      });
      
      document.getElementById("close-admin").addEventListener("click", function() {
        adminPanelDiv.style.display = "none";
      });
      
      // Pulsante per visualizzare la classifica pubblica
      document.getElementById("view-leaderboard").addEventListener("click", function() {
        let playerName = document.getElementById("player-name").value.trim();
        showLeaderboard(playerName, 0);
      });
      
      // Toggle per la selezione degli accordi
      const toggleButtons = document.querySelectorAll('.toggle-btn');
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('active');
        });
      });
      
      // Funzioni helper per accordi e note
      function accidentalValue(acc) {
        let value = 0;
        for (let ch of acc) {
          if (ch === "#") value++;
          else if (ch === "b") value--;
        }
        return value;
      }
      function getPitch(note) {
        let naturalPitches = {"C":0, "D":2, "E":4, "F":5, "G":7, "A":9, "B":11};
        let letter = note[0], acc = note.slice(1);
        let base = naturalPitches[letter];
        return ((base + accidentalValue(acc)) % 12 + 12) % 12;
      }
      function formatNote(note, useSharps, withOctave) {
        let m = note.match(/^([A-G](?:#|b)*)(\d+)?$/);
        if (m) {
          let notePart = m[1], octave = m[2] || "";
          return useSharps ? notePart + (withOctave ? octave : "") : notePart + (withOctave ? octave : "");
        }
        return note;
      }
      function classicalToKeyboard(note) {
        let naturalPitches = {"C":0, "D":2, "E":4, "F":5, "G":7, "A":9, "B":11};
        let letter = note[0], acc = note.slice(1);
        let pitch = naturalPitches[letter] + accidentalValue(acc);
        pitch = ((pitch % 12) + 12) % 12;
        const keyboardNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
        return keyboardNames[pitch];
      }
      function spellNote(root, degree, semitoneOffset) {
        let letters = ["A","B","C","D","E","F","G"];
        let naturalPitches = {"C":0, "D":2, "E":4, "F":5, "G":7, "A":9, "B":11};
        let rootLetter = root[0], rootAcc = root.slice(1);
        let rootPitch = naturalPitches[rootLetter] + accidentalValue(rootAcc);
        let targetPitch = (rootPitch + semitoneOffset) % 12;
        if (targetPitch < 0) targetPitch += 12;
        let rootIndex = letters.indexOf(rootLetter);
        let expectedLetter = letters[(rootIndex + degree) % 7],
            expectedNatural = naturalPitches[expectedLetter],
            diff = targetPitch - expectedNatural;
        if (diff > 6) diff -= 12;
        if (diff < -6) diff += 12;
        let accStr = "";
        if (diff > 0) {
          for (let i = 0; i < diff; i++) accStr += "#";
        } else if (diff < 0) {
          for (let i = 0; i < -diff; i++) accStr += "b";
        }
        return expectedLetter + accStr;
      }
      function assignChordOctaves(chordNotes, baseOctave, rootNote) {
        let assigned = [];
        let rootPitch = getPitch(rootNote);
        let prevAbs = baseOctave * 12 + rootPitch;
        assigned.push(rootNote + baseOctave);
        for (let i = 1; i < chordNotes.length; i++) {
          let note = chordNotes[i], octave = baseOctave;
          while ((octave * 12 + getPitch(note)) <= prevAbs) {
            octave++;
          }
          let abs = octave * 12 + getPitch(note);
          assigned.push(note + octave);
          prevAbs = abs;
        }
        return assigned;
      }
      
      // Formule degli accordi
      const chordFormulas = {
        "":        [ {degree:0, semitones:0}, {degree:2, semitones:4}, {degree:4, semitones:7} ],
        "m":       [ {degree:0, semitones:0}, {degree:2, semitones:3}, {degree:4, semitones:7} ],
        "7":       [ {degree:0, semitones:0}, {degree:2, semitones:4}, {degree:4, semitones:7}, {degree:6, semitones:10} ],
        "maj7":    [ {degree:0, semitones:0}, {degree:2, semitones:4}, {degree:4, semitones:7}, {degree:6, semitones:11} ],
        "m(maj7)": [ {degree:0, semitones:0}, {degree:2, semitones:3}, {degree:4, semitones:7}, {degree:6, semitones:11} ],
        "aug":     [ {degree:0, semitones:0}, {degree:2, semitones:4}, {degree:4, semitones:8} ],
        "dim":     [ {degree:0, semitones:0}, {degree:2, semitones:3}, {degree:4, semitones:6} ],
        "sus2":    [ {degree:0, semitones:0}, {degree:1, semitones:2}, {degree:4, semitones:7} ],
        "sus4":    [ {degree:0, semitones:0}, {degree:3, semitones:5}, {degree:4, semitones:7} ]
      };
      
      const chordNamesItalian = {
        "": "maggiore",
        "m": "minore",
        "7": "7",
        "maj7": "maj7",
        "m(maj7)": "min‚Äëmaj7",
        "aug": "aumentato",
        "dim": "diminuito",
        "sus2": "sus2",
        "sus4": "sus4"
      };
      
      // Campionatore di pianoforte
      const piano = new Tone.Sampler({
        urls: {
          "C4": "C4.mp3",
          "D#4": "Ds4.mp3",
          "F#4": "Fs4.mp3",
          "A4": "A4.mp3"
        },
        release: 1,
        baseUrl: "https://tonejs.github.io/audio/salamander/"
      }).toDestination();
      
      // Costruzione della tastiera
      const keyElements = {};
      const keyboard = document.getElementById('keyboard');
      const totalWhiteKeys = 14;
      const containerWidth = keyboard.clientWidth || 600;
      const whiteKeyWidth = containerWidth / totalWhiteKeys;
      const whiteKeyHeight = whiteKeyWidth * 5;
      const blackKeyWidth = whiteKeyWidth * 0.6;
      const blackKeyHeight = whiteKeyHeight * 0.6;
      keyboard.style.height = whiteKeyHeight + "px";
      const octaveNotes = [
        { note:'C', type:'white' }, { note:'C#', type:'black' },
        { note:'D', type:'white' }, { note:'D#', type:'black' },
        { note:'E', type:'white' }, { note:'F', type:'white' },
        { note:'F#', type:'black' }, { note:'G', type:'white' },
        { note:'G#', type:'black' }, { note:'A', type:'white' },
        { note:'A#', type:'black' }, { note:'B', type:'white' }
      ];
      let whiteKeyCount = 0;
      const startOctave = 4;
      const numOctaves = 2;
      for (let o = 0; o < numOctaves; o++) {
        let octave = startOctave + o;
        for (let i = 0; i < octaveNotes.length; i++) {
          let noteObj = octaveNotes[i];
          let fullNote = noteObj.note + octave;
          if (noteObj.type === 'white') {
            let key = document.createElement('div');
            key.classList.add('white-key');
            key.dataset.note = fullNote;
            key.style.width = whiteKeyWidth + "px";
            key.style.height = whiteKeyHeight + "px";
            key.style.left = (whiteKeyCount * whiteKeyWidth) + "px";
            let label = document.createElement('div');
            label.classList.add('key-label');
            label.textContent = formatNote(fullNote.replace(/\d+/,""), defaultUseSharps, false);
            key.appendChild(label);
            keyboard.appendChild(key);
            keyElements[fullNote] = key;
            whiteKeyCount++;
          } else if (noteObj.type === 'black') {
            let key = document.createElement('div');
            key.classList.add('black-key');
            key.dataset.note = fullNote;
            let offset = whiteKeyCount - 1;
            key.style.width = blackKeyWidth + "px";
            key.style.height = blackKeyHeight + "px";
            key.style.left = (offset * whiteKeyWidth + whiteKeyWidth - (blackKeyWidth / 2)) + "px";
            keyboard.appendChild(key);
            keyElements[fullNote] = key;
          }
        }
      }
      function clearKeyboardSelection() {
        Object.values(keyElements).forEach(el => el.classList.remove('active'));
      }
      
      // ---------------------------
      // FUNZIONI DEL GIOCO
      // ---------------------------
      
      // La funzione processAnswer controlla il contatore:
      // - <3: bottone rimane grigio.
      // - 3-9: bottone assume la classe bonus-active (rosso pulsante).
      // - >=10: bottone assume la classe rainbow (il solo background cambia seguendo il ciclo: 
      //    "rosso, giallo, blu" ‚Üí "blu, rosso, giallo" ‚Üí "giallo, blu, rosso")
      function processAnswer(isCorrect, message) {
        Array.from(document.querySelectorAll('.chord-button')).forEach(b => b.disabled = true);
        if (isCorrect) {
          consecutiveCorrect++;
          let basePoints;
          if (currentChordType === "" || currentChordType === "m") {
            basePoints = 50;
          } else {
            let extra = allowedChordTypes.length - 2;
            if (extra < 0) extra = 0;
            basePoints = 50 + 200 * extra * 2;
          }
          let extra = allowedChordTypes.length - 2;
          if (extra < 0) extra = 0;
          let bonus = (consecutiveCorrect >= 3) ? Math.round((100 + (100 * extra * 2)) * Math.pow(1.2, consecutiveCorrect - 3)) : 0;
          let pointsAwarded = basePoints + bonus;
          score += pointsAwarded;
          document.getElementById('chord-info').innerHTML = "<span style='color: green; font-size: 20px;'>Corretto! +" + pointsAwarded + " punti</span>";
          document.getElementById("scoreboard").style.color = "green";
          if (consecutiveCorrect >= 3 && consecutiveCorrect < 10) {
            bonusIndicator.classList.remove('rainbow');
            bonusIndicator.classList.add('bonus-active');
            bonusIndicator.textContent = "Bonus +" + bonus;
          } else if (consecutiveCorrect >= 10) {
            bonusIndicator.classList.remove('bonus-active');
            bonusIndicator.classList.add('rainbow');
            bonusIndicator.textContent = "Bonus +" + bonus;
          } else {
            bonusIndicator.classList.remove('bonus-active');
            bonusIndicator.classList.remove('rainbow');
            bonusIndicator.textContent = "Bonus";
          }
          animateScore(score);
          setTimeout(() => {
            generateRandomChord();
            Array.from(document.querySelectorAll('.chord-button')).forEach(b => b.disabled = false);
          }, 150);
          setTimeout(() => { document.getElementById('chord-info').innerHTML = ""; }, 1500);
        } else {
          let penalty = Math.floor(score / 5);
          score -= penalty;
          consecutiveCorrect = 0;
          bonusIndicator.classList.remove('bonus-active');
          bonusIndicator.classList.remove('rainbow');
          bonusIndicator.textContent = "Bonus";
          document.getElementById('chord-info').innerHTML = "<span style='color: red; font-size: 20px;'>Sbagliato! Riprova (-" + penalty + ")</span>";
          document.getElementById("scoreboard").style.color = "red";
          animateScore(score);
          setTimeout(() => {
            Array.from(document.querySelectorAll('.chord-button')).forEach(b => b.disabled = false);
            setTimeout(() => { document.getElementById('chord-info').innerHTML = ""; }, 1500);
          }, 150);
        }
      }
      
      function generaBottoniRisposta() {
        const container = document.getElementById('chord-buttons');
        container.innerHTML = "";
        const opzioni = document.querySelectorAll('.toggle-btn');
        opzioni.forEach(opzione => {
          if (opzione.classList.contains('active')) {
            let tipo = opzione.getAttribute('data-chord');
            let btn = document.createElement('button');
            btn.classList.add('chord-button');
            btn.dataset.chord = tipo;
            btn.textContent = chordNamesItalian[tipo] || tipo;
            btn.addEventListener('click', function() {
              if (!gameActive) return;
              if (this.dataset.chord === currentChordType) {
                this.classList.add('flash-correct');
                setTimeout(() => { this.classList.remove('flash-correct'); }, 300);
                processAnswer(true, "Corretto!");
              } else {
                this.classList.add('flash-wrong');
                setTimeout(() => { this.classList.remove('flash-wrong'); }, 300);
                processAnswer(false, "Sbagliato! Riprova");
              }
            });
            container.appendChild(btn);
          }
        });
      }
      
      function animateScore(finalScore) {
        let start = displayedScore;
        let change = finalScore - start;
        let duration = 1000;
        let startTime = null;
        function animate(timestamp) {
          if (!startTime) startTime = timestamp;
          let progress = timestamp - startTime;
          let currentValue = Math.round(start + (change * progress / duration));
          document.getElementById("scoreboard").textContent = "Punteggio: " + currentValue;
          if (progress < duration) {
            requestAnimationFrame(animate);
          } else {
            document.getElementById("scoreboard").textContent = "Punteggio: " + finalScore;
            displayedScore = finalScore;
            setTimeout(() => {
              document.getElementById("scoreboard").style.color = "black";
            }, 500);
          }
        }
        requestAnimationFrame(animate);
      }
      
      function startGlobalTimer(durationMs) {
        const timerBar = document.getElementById('timer-bar');
        timerBar.style.width = "100%";
        gameEndTime = Date.now() + durationMs;
        globalTimerInterval = setInterval(() => {
          let remaining = gameEndTime - Date.now();
          let percent = remaining / durationMs;
          if (percent < 0) percent = 0;
          timerBar.style.width = (percent * 100) + "%";
          if (remaining <= 15000) {
            timerBar.classList.add("time-warning");
          } else {
            timerBar.classList.remove("time-warning");
          }
          if (remaining <= 0) {
            clearInterval(globalTimerInterval);
            updateLeaderboardFlag = true;
            endGameDueToTime();
          }
        }, 50);
      }
      
      function endGameDueToTime() {
        gameActive = false;
        document.getElementById('chord-info').innerHTML = "<span>Tempo scaduto! Punteggio finale: " + score + "</span>";
        Array.from(document.querySelectorAll('.chord-button')).forEach(b => b.disabled = true);
        setTimeout(() => { finishGame(); }, 1500);
      }
      
      function generateRandomChord() {
        clearKeyboardSelection();
        document.getElementById('chord-info').innerHTML = "";
        selectedRoot = allowedRootNotes[Math.floor(Math.random() * allowedRootNotes.length)];
        currentChordType = allowedChordTypes[Math.floor(Math.random() * allowedChordTypes.length)];
        playCurrentChord();
      }
      
      function playCurrentChord() {
        clearKeyboardSelection();
        let m = selectedRoot.match(/^([A-G](?:#|b)?)/);
        if (!m) return;
        let rootNote = m[1];
        let formula = chordFormulas[currentChordType];
        if (!formula) {
          document.getElementById('chord-info').textContent = "Accordo non riconosciuto";
          return;
        }
        let chordNotes = formula.map(f => spellNote(rootNote, f.degree, f.semitones));
        let baseOctave = parseInt(selectedRoot.match(/\d+/)[0]);
        let assignedChordNotes = assignChordOctaves(chordNotes, baseOctave, rootNote);
        let notesForPlayback = assignedChordNotes.map(note => {
          let m = note.match(/^([A-G](?:#|b)*)(\d+)$/);
          if (m) {
            let notePart = m[1], octave = m[2];
            return classicalToKeyboard(notePart) + octave;
          }
          return note;
        });
        lastChordNotes = notesForPlayback;
        if (soundOn) {
          Tone.start();
          notesForPlayback.forEach((note, i) => {
            setTimeout(() => {
              piano.triggerAttackRelease(note, "2n", undefined, 0.7);
            }, i * 5);
          });
        }
        assignedChordNotes.forEach(note => {
          let match = note.match(/^([A-G](?:#|b)*)(\d+)$/);
          if (match) {
            let notePart = match[1], octave = match[2];
            let kbNote = classicalToKeyboard(notePart);
            let keyName = kbNote + octave;
            if (keyElements[keyName]) { keyElements[keyName].classList.add('active'); }
          }
        });
      }
      
      function playArpeggio(notes) {
        notes.forEach((note, i) => {
          setTimeout(() => {
            piano.triggerAttackRelease(note, "2n", undefined, 0.7);
          }, i * 300);
        });
      }
      
      document.getElementById('end-game').addEventListener('click', () => {
        gameActive = false;
        clearInterval(globalTimerInterval);
        updateLeaderboardFlag = false;
        document.getElementById('chord-info').innerHTML = "<span>Gioco terminato manualmente. Il punteggio non verr√† conteggiato.</span>";
        Array.from(document.querySelectorAll('.chord-button')).forEach(b => b.disabled = true);
        setTimeout(() => { finishGame(); }, 150);
      });
      
      document.getElementById('replay-chord').addEventListener('click', () => {
        if (gameActive && lastChordNotes.length > 0) {
          playArpeggio(lastChordNotes);
        }
      });
      
      async function finishGame() {
        let playerName = document.getElementById('player-name').value.trim() || "giocatore";
        updateGamePlayedCounter();
        if (trialMode) {
          // Modalit√† prova: non mostrare info sul punteggio
          document.getElementById('game-panel').style.display = "none";
          document.getElementById('scoreboard').style.display = "block";
          document.getElementById('chord-info').style.display = "block";
          document.getElementById('config-panel').style.display = "block";
          trialMode = false;
        } else {
          if (updateLeaderboardFlag) {
            await updateLeaderboard(playerName, score);
          }
          document.getElementById('game-panel').style.display = "none";
          showLeaderboard(playerName, score);
        }
      }
      
      // Aggiorna le shortcut dai campi input
      function updateCustomShortcuts() {
        customShortcuts = {
          "": document.getElementById("shortcut-major").value.toUpperCase() || "Q",
          "m": document.getElementById("shortcut-m").value.toUpperCase() || "W",
          "7": document.getElementById("shortcut-7").value.toUpperCase() || "E",
          "maj7": document.getElementById("shortcut-maj7").value.toUpperCase() || "R",
          "m(maj7)": document.getElementById("shortcut-mmaj7").value.toUpperCase() || "T",
          "aug": document.getElementById("shortcut-aug").value.toUpperCase() || "Y",
          "dim": document.getElementById("shortcut-dim").value.toUpperCase() || "U",
          "sus2": document.getElementById("shortcut-sus2").value.toUpperCase() || "I",
          "sus4": document.getElementById("shortcut-sus4").value.toUpperCase() || "O"
        };
      }
      
      // Listener per la barra spaziatrice (replay arpeggio)
      document.addEventListener("keydown", function(event) {
        if (event.code === "Space") {
          if (gameActive && lastChordNotes.length > 0) {
            playArpeggio(lastChordNotes);
          }
        }
      });
      
      // Listener per le shortcut durante il gioco
      document.addEventListener('keydown', function(event) {
        if (!gameActive) return;
        const key = event.key.toUpperCase();
        for (const chord in customShortcuts) {
          if (customShortcuts[chord] === key) {
            const btn = document.querySelector(`.chord-button[data-chord="${chord}"]`);
            if (btn && !btn.disabled) {
              btn.click();
              break;
            }
          }
        }
      });
      
      // Avvio partita modalit√† normale
      document.getElementById('start-game').addEventListener('click', () => {
        updateCustomShortcuts();
        allowedChordTypes = [];
        const opzioni = document.querySelectorAll('.toggle-btn');
        opzioni.forEach(opzione => {
          if (opzione.classList.contains('active')) {
            allowedChordTypes.push(opzione.getAttribute('data-chord'));
          }
        });
        if (allowedChordTypes.length === 1) {
          alert("Seleziona almeno due tipi di accordo su cui allenarti!");
          return;
        }
        document.getElementById('scoreboard').style.display = "block";
        document.getElementById('chord-info').style.display = "block";
        const mostraKeyboard = document.getElementById('toggle-keyboard').checked;
        keyboard.style.display = mostraKeyboard ? "block" : "none";
        document.getElementById('config-panel').style.display = "none";
        document.getElementById('game-panel').style.display = "block";
        document.getElementById('chord-info').innerHTML = "";
        generaBottoniRisposta();
        score = 0;
        displayedScore = 0;
        document.getElementById('scoreboard').textContent = "Punteggio: 0";
        consecutiveCorrect = 0;
        bonusIndicator.classList.remove('bonus-active');
        bonusIndicator.classList.remove('rainbow');
        bonusIndicator.textContent = "Bonus";
        updateLeaderboardFlag = true;
        gameActive = true;
        trialMode = false;
        startGlobalTimer(FIXED_DURATION);
        generateRandomChord();
      });
      
      // Avvio partita modalit√† "Prova"
      document.getElementById('start-trial').addEventListener('click', () => {
        updateCustomShortcuts();
        allowedChordTypes = [];
        const opzioni = document.querySelectorAll('.toggle-btn');
        opzioni.forEach(opzione => {
          if (opzione.classList.contains('active')) {
            allowedChordTypes.push(opzione.getAttribute('data-chord'));
          }
        });
        if (allowedChordTypes.length === 1) {
          alert("Seleziona almeno due tipi di accordo su cui allenarti!");
          return;
        }
        document.getElementById('scoreboard').style.display = "none";
        document.getElementById('chord-info').style.display = "none";
        const mostraKeyboard = document.getElementById('toggle-keyboard').checked;
        keyboard.style.display = mostraKeyboard ? "block" : "none";
        document.getElementById('config-panel').style.display = "none";
        document.getElementById('game-panel').style.display = "block";
        generaBottoniRisposta();
        score = 0;
        displayedScore = 0;
        document.getElementById('scoreboard').textContent = "";
        consecutiveCorrect = 0;
        bonusIndicator.classList.remove('bonus-active');
        bonusIndicator.classList.remove('rainbow');
        bonusIndicator.textContent = "Bonus";
        updateLeaderboardFlag = false;
        trialMode = true;
        gameActive = true;
        startGlobalTimer(FIXED_DURATION);
        generateRandomChord();
      });
      
      // Toggle per mostrare/nascondere il pannello delle shortcut
      document.getElementById('toggle-shortcuts').addEventListener('click', () => {
        const panel = document.getElementById('shortcuts-panel');
        panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
      });
      
      // Event listener per il tasto "Chiudi Classifica"
      document.getElementById('close-leaderboard').addEventListener('click', () => {
        console.log('Chiudi Classifica cliccato');
        document.getElementById('leaderboard-panel').style.display = "none";
        document.getElementById('config-panel').style.display = "block";
      });
      function scrollToHighlighted() {
  const container = document.getElementById("leaderboard-content");
  const highlightedRow = container.querySelector(".highlight");
  if (!highlightedRow) return;
  
  // Imposta lo scroll iniziale sul fondo del contenitore
  container.scrollTop = container.scrollHeight - container.clientHeight;
  
  // Calcola la posizione target per centrare la riga evidenziata
  const targetScroll = highlightedRow.offsetTop - (container.clientHeight / 2) + (highlightedRow.clientHeight / 2);
  
  const startScroll = container.scrollTop;
  const distance = targetScroll - startScroll;
  const duration = 1500; // Durata dell'animazione in millisecondi
  const startTime = performance.now();
  
  // Funzione di easing: easeOutCubic
  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }
  
  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const t = Math.min(elapsed / duration, 1); // t varia da 0 a 1
    const easedT = easeOutCubic(t);
    container.scrollTop = startScroll + distance * easedT;
    
    if (t < 1) {
      requestAnimationFrame(animate);
    }
  }
  
  requestAnimationFrame(animate);
}

    })(); // Fine IIFE
  </script>
</body>
</html>
